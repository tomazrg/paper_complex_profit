y = "",
fill = "Severity (%)"
) +
geom_text(size = 4)+
scale_fill_viridis_c(option = "D",begin = 0.2, end = 1, na.value = "grey80") +
ggthemes::theme_few()+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 16, face = "bold"),
strip.text = element_text(size = 16, face = "bold"),
title = element_text(face = "bold"),
legend.position = "right")
p_heat
p_heat <- ggplot(heat_dat2, aes(x = disease, y = trial_ord, fill = severity,
label = round(severity,2))) +
geom_tile(color = "white", linewidth = 0.2) +
labs(
x = "Disease severity (%) in the non-treated",
y = "",
fill = "Severity (%)"
) +
geom_text(size = 4)+
scale_fill_viridis_c(option = "D",begin = 0.3, end = 1, na.value = "grey80") +
ggthemes::theme_few()+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 16, face = "bold"),
strip.text = element_text(size = 16, face = "bold"),
title = element_text(face = "bold"),
legend.position = "right")
p_heat
p_heat <- ggplot(heat_dat2, aes(x = disease, y = trial_ord, fill = severity,
label = round(severity,2))) +
geom_tile(color = "white", linewidth = 0.2) +
labs(
x = "Disease severity (%) in the non-treated",
y = "",
fill = "Severity (%)"
) +
geom_text(size = 4)+
scale_fill_viridis_c(option = "D",begin = 0.6, end = 1, na.value = "grey80") +
ggthemes::theme_few()+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 16, face = "bold"),
strip.text = element_text(size = 16, face = "bold"),
title = element_text(face = "bold"),
legend.position = "right")
p_heat
p_heat <- ggplot(heat_dat2, aes(x = disease, y = trial_ord, fill = severity,
label = round(severity,2))) +
geom_tile(color = "white", linewidth = 0.2) +
labs(
x = "Disease severity (%) in the non-treated",
y = "",
fill = "Severity (%)"
) +
geom_text(size = 4)+
scale_fill_viridis_c(option = "D",begin = 0.1, end = 1, na.value = "grey80") +
ggthemes::theme_few()+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 16, face = "bold"),
strip.text = element_text(size = 16, face = "bold"),
title = element_text(face = "bold"),
legend.position = "right")
p_heat
p_heat <- ggplot(heat_dat2, aes(x = disease, y = trial_ord, fill = severity,
label = round(severity,2))) +
geom_tile(color = "white", linewidth = 0.2) +
labs(
x = "Disease severity (%) in the non-treated",
y = "",
fill = "Severity (%)"
) +
geom_text(size = 4)+
scale_fill_viridis_c(option = "D",begin = 0.2, end = 1, na.value = "grey80") +
ggthemes::theme_few()+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 16, face = "bold"),
strip.text = element_text(size = 16, face = "bold"),
title = element_text(face = "bold"),
legend.position = "right")
p_heat
p_heat <- ggplot(heat_dat2, aes(x = disease, y = trial_ord, fill = severity,
label = round(severity,2))) +
geom_tile(color = "white", linewidth = 0.2) +
labs(
x = "Disease severity (%) in the non-treated",
y = "",
fill = "Severity (%)"
) +
geom_text(size = 4)+
scale_fill_viridis_c(option = "D",begin = 0.3, end = 1, na.value = "grey80") +
ggthemes::theme_few()+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 16, face = "bold"),
strip.text = element_text(size = 16, face = "bold"),
title = element_text(face = "bold"),
legend.position = "right")
p_heat
ggsave("fig/heat_disease.png", bg = "white", dpi = 600, height = 8, width = 12)
p_heat <- ggplot(heat_dat2, aes(x = disease, y = trial_ord, fill = severity,
label = round(severity,2))) +
geom_tile(color = "white", linewidth = 0.2) +
labs(
x = "Disease severity (%) in the non-treated",
y = "",
fill = "Severity (%)"
) +
geom_text(size = 4)+
scale_fill_viridis_c(option = "D",begin = 0.3, end = 1, na.value = "grey80") +
ggthemes::theme_few()+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 16, face = "bold"),
strip.text = element_text(size = 16, face = "bold"),
title = element_text(face = "bold"),
legend.position = "top")
p_heat
ggsave("fig/heat_disease.png", bg = "white", dpi = 600, height = 8, width = 12)
p_heat <- ggplot(heat_dat2, aes(x = disease, y = trial_ord, fill = severity,
label = round(severity,2))) +
geom_tile(color = "white", linewidth = 0.2) +
labs(
x = "Disease severity (%) in the non-treated",
y = "",
fill = "Severity (%)"
) +
geom_text(size = 4)+
scale_fill_viridis_c(option = "D",begin = 0.3, end = 1, na.value = "grey80") +
ggthemes::theme_few()+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 16, face = "bold"),
strip.text = element_text(size = 16, face = "bold"),
title = element_text(face = "bold"),
legend.position = "right")
p_heat
ggsave("fig/heat_disease.png", bg = "white", dpi = 600, height = 8, width = 12)
es$pressure <- factor(es$pressure,
levels = c("Disease absent (≤2%)", "Disease present (>2%)"))
newP <- data.frame(pressure = levels(es$pressure))
X_P <- model.matrix(~ pressure, data = newP)[, -1, drop = FALSE]  # one column
pred_P <- predict(mP, newmods = X_P)
pred_tab <- data.frame(
pressure = newP$pressure,
gain_hat = pred_P$pred,
se       = pred_P$se,
ci_lb    = pred_P$ci.lb,
ci_ub    = pred_P$ci.ub
)
pred_tab
es$season <- factor(es$season,
levels = c("first", "second"))
newP <- data.frame(season = levels(es$season))
X_P <- model.matrix(~ season, data = newP)[, -1, drop = FALSE]  # one column
pred_P <- predict(mP2, newmods = X_P)
pred_tab2 <- data.frame(
season = newP$season,
gain_hat = pred_P$pred,
se       = pred_P$se,
ci_lb    = pred_P$ci.lb,
ci_ub    = pred_P$ci.ub
)
pred_tab2
hyb_lnr <- hyb_diff %>%
filter(yield_check > 0, yield_treated > 0) %>%
mutate(lnRR = log(yield_treated / yield_check))
es_lnr <- hyb_lnr %>%
group_by(trial, year, location, season) %>%
summarise(
yi = mean(lnRR, na.rm = TRUE),
vi = var(lnRR, na.rm = TRUE) / sum(!is.na(lnRR)),
.groups = "drop"
) %>%
filter(is.finite(vi), vi > 0) %>%
left_join(es %>% select(trial, pressure), by = "trial")
es_lnr
mP_lnr <- rma(yi, vi, mods = ~ pressure, data = es_lnr, method = "REML")
mP_lnr
# HIGH
s <- summary(mP_lnr)
# Extract the moderator row (difference)
b1_est <- s$b[2]          # lnRR difference: present - absent
b1_lb  <- s$ci.lb[2]      # lower CI
b1_ub  <- s$ci.ub[2]      # upper CI
# Convert lnRR difference to ratio
ratio_diff    <- exp(b1_est)
ratio_diff_lb <- exp(b1_lb)
ratio_diff_ub <- exp(b1_ub)
# Convert ratio to % change
pct_diff    <- (ratio_diff    - 1) * 100
pct_diff_lb <- (ratio_diff_lb - 1) * 100
pct_diff_ub <- (ratio_diff_ub - 1) * 100
# Put into a simple table
diff_table <- data.frame(
comparison = "Treated vs Non-treated",
pct_diff  = pct_diff,
pct_lb    = pct_diff_lb,
pct_ub    = pct_diff_ub
)
diff_table
# LOW
s <- summary(mP_lnr)
# Extract the moderator row (difference)
b1_est <- s$b[1]          # lnRR difference: present - absent
b1_lb  <- s$ci.lb[1]      # lower CI
b1_ub  <- s$ci.ub[1]      # upper CI
# Convert lnRR difference to ratio
ratio_diff    <- exp(b1_est)
ratio_diff_lb <- exp(b1_lb)
ratio_diff_ub <- exp(b1_ub)
# Convert ratio to % change
pct_diff    <- (ratio_diff    - 1) * 100
pct_diff_lb <- (ratio_diff_lb - 1) * 100
pct_diff_ub <- (ratio_diff_ub - 1) * 100
# Put into a simple table
diff_table <- data.frame(
comparison = "Treated vs Non-treated",
pct_diff  = pct_diff,
pct_lb    = pct_diff_lb,
pct_ub    = pct_diff_ub
)
diff_table
mP_lnr2 <- rma(yi, vi, mods = ~ season, data = es_lnr, method = "REML")
mP_lnr2
s2 <- summary(mP_lnr2)
# Extract the moderator row (difference)
b1_est <- s2$b[2]          # lnRR difference: present - absent
b1_lb  <- s2$ci.lb[2]      # lower CI
b1_ub  <- s2$ci.ub[2]      # upper CI
# Convert lnRR difference to ratio
ratio_diff    <- exp(b1_est)
ratio_diff_lb <- exp(b1_lb)
ratio_diff_ub <- exp(b1_ub)
# Convert ratio to % change
pct_diff    <- (ratio_diff    - 1) * 100
pct_diff_lb <- (ratio_diff_lb - 1) * 100
pct_diff_ub <- (ratio_diff_ub - 1) * 100
# Put into a simple table
diff_table2 <- data.frame(
comparison = "First vs Second",
pct_diff  = pct_diff,
pct_lb    = pct_diff_lb,
pct_ub    = pct_diff_ub
)
diff_table2
if (max(pred_tab$gain_hat) < 20) {
pred_tab <- pred_tab %>%
mutate(across(c(gain_hat, ci_lb, ci_ub, se), ~ .x * 1000))
}
Gcrit <- 1000 * cost / price
econ_tab <- pred_tab %>%
mutate(
Net      = gain_hat * price / 1000 - cost,
Net_lb   = ci_lb    * price / 1000 - cost,
Net_ub   = ci_ub    * price / 1000 - cost,
Prob_Pos = 1 - pnorm((Gcrit - gain_hat) / se)
)
econ_tab
# HIGH
s <- summary(mP_lnr)
# Extract the moderator row (difference)
b1_est <- s$b[2]          # lnRR difference: present - absent
b1_lb  <- s$ci.lb[2]      # lower CI
b1_ub  <- s$ci.ub[2]      # upper CI
# Convert lnRR difference to ratio
ratio_diff    <- exp(b1_est)
ratio_diff_lb <- exp(b1_lb)
ratio_diff_ub <- exp(b1_ub)
# Convert ratio to % change
pct_diff    <- (ratio_diff    - 1) * 100
pct_diff_lb <- (ratio_diff_lb - 1) * 100
pct_diff_ub <- (ratio_diff_ub - 1) * 100
# Put into a simple table
diff_table <- data.frame(
comparison = "Treated vs Non-treated",
pct_diff  = pct_diff,
pct_lb    = pct_diff_lb,
pct_ub    = pct_diff_ub
)
diff_table
# LOW
s <- summary(mP_lnr)
# Extract the moderator row (difference)
b1_est <- s$b[1]          # lnRR difference: present - absent
b1_lb  <- s$ci.lb[1]      # lower CI
b1_ub  <- s$ci.ub[1]      # upper CI
# Convert lnRR difference to ratio
ratio_diff    <- exp(b1_est)
ratio_diff_lb <- exp(b1_lb)
ratio_diff_ub <- exp(b1_ub)
# Convert ratio to % change
pct_diff    <- (ratio_diff    - 1) * 100
pct_diff_lb <- (ratio_diff_lb - 1) * 100
pct_diff_ub <- (ratio_diff_ub - 1) * 100
# Put into a simple table
diff_table <- data.frame(
comparison = "Treated vs Non-treated",
pct_diff  = pct_diff,
pct_lb    = pct_diff_lb,
pct_ub    = pct_diff_ub
)
diff_table
mP_lnr <- rma(yi, vi, mods = ~ pressure, data = es_lnr, method = "REML")
mP_lnr
mP2 <- rma(yi, vi, mods = ~ season, data = es, method = "REML")
mP2
es %>%
filter(sev_sum > 0.1) %>%
summarise(
mean = mean(sev_sum),
min = min(sev_sum),
max = max(sev_sum),
median = median(sev_sum)
)
es$pressure <- factor(es$pressure,
levels = c("Disease absent (≤2%)", "Disease present (>2%)"))
newP <- data.frame(pressure = levels(es$pressure))
X_P <- model.matrix(~ pressure, data = newP)[, -1, drop = FALSE]  # one column
pred_P <- predict(mP, newmods = X_P)
pred_tab <- data.frame(
pressure = newP$pressure,
gain_hat = pred_P$pred,
se       = pred_P$se,
ci_lb    = pred_P$ci.lb,
ci_ub    = pred_P$ci.ub
)
pred_tab
Gcrit <- 1000 * cost / price
econ_tab <- pred_tab %>%
mutate(
Net      = gain_hat * price / 1000 - cost,
Net_lb   = ci_lb    * price / 1000 - cost,
Net_ub   = ci_ub    * price / 1000 - cost,
Prob_Pos = 1 - pnorm((Gcrit - gain_hat) / se)
)
econ_tab
es$pressure <- factor(es$pressure,
levels = c("Disease absent (≤2%)", "Disease present (>2%)"))
newP <- data.frame(pressure = levels(es$pressure))
X_P <- model.matrix(~ pressure, data = newP)[, -1, drop = FALSE]  # one column
pred_P <- predict(mP, newmods = X_P)
pred_tab <- data.frame(
pressure = newP$pressure,
gain_hat = pred_P$pred,
se       = pred_P$se,
ci_lb    = pred_P$ci.lb,
ci_ub    = pred_P$ci.ub
)
pred_tab
Gcrit <- 1000 * cost / price
econ_tab <- pred_tab %>%
mutate(
Net      = gain_hat * price / 1000 - cost,
Net_lb   = ci_lb    * price / 1000 - cost,
Net_ub   = ci_ub    * price / 1000 - cost,
Prob_Pos = 1 - pnorm((Gcrit - gain_hat) / se)
)
econ_tab
pred_tab
Gcrit <- 1000 * cost / price
econ_tab <- pred_tab %>%
mutate(
Net      = gain_hat * price / 1000 - cost,
Net_lb   = ci_lb    * price / 1000 - cost,
Net_ub   = ci_ub    * price / 1000 - cost,
Prob_Pos = 1 - pnorm((Gcrit - gain_hat) / se)
)
econ_tab
mP <- rma(yi, vi, mods = ~ pressure, data = es, method = "REML")
mP
es$pressure <- factor(es$pressure,
levels = c("Disease absent (≤2%)", "Disease present (>2%)"))
newP <- data.frame(pressure = levels(es$pressure))
X_P <- model.matrix(~ pressure, data = newP)[, -1, drop = FALSE]  # one column
pred_P <- predict(mP, newmods = X_P)
pred_tab <- data.frame(
pressure = newP$pressure,
gain_hat = pred_P$pred,
se       = pred_P$se,
ci_lb    = pred_P$ci.lb,
ci_ub    = pred_P$ci.ub
)
pred_tab
hyb_lnr <- hyb_diff %>%
filter(yield_check > 0, yield_treated > 0) %>%
mutate(lnRR = log(yield_treated / yield_check))
es_lnr <- hyb_lnr %>%
group_by(trial, year, location, season) %>%
summarise(
yi = mean(lnRR, na.rm = TRUE),
vi = var(lnRR, na.rm = TRUE) / sum(!is.na(lnRR)),
.groups = "drop"
) %>%
filter(is.finite(vi), vi > 0) %>%
left_join(es %>% select(trial, pressure), by = "trial")
es_lnr
if (max(pred_tab$gain_hat) < 20) {
pred_tab <- pred_tab %>%
mutate(across(c(gain_hat, ci_lb, ci_ub, se), ~ .x * 1000))
}
Gcrit <- 1000 * cost / price
econ_tab <- pred_tab %>%
mutate(
Net      = gain_hat * price / 1000 - cost,
Net_lb   = ci_lb    * price / 1000 - cost,
Net_ub   = ci_ub    * price / 1000 - cost,
Prob_Pos = 1 - pnorm((Gcrit - gain_hat) / se)
)
econ_tab
sack_kg <- 60
econ_tab2 <- econ_tab %>%
mutate(
Prob_5s  = 1 - pnorm((5  * sack_kg - gain_hat) / se),
Prob_10s = 1 - pnorm((10 * sack_kg - gain_hat) / se),
Prob_15s = 1 - pnorm((15 * sack_kg - gain_hat) / se)
)
econ_tab2
citation("cowplot")
citation("dplyr")
citation("ggplot2")
citation("tidytext")
citation()
p_heat <- ggplot(heat_dat2, aes(x = disease, y = trial_ord, fill = severity,
label = round(severity,2))) +
geom_tile(color = "white", linewidth = 0.2) +
labs(
x = "Disease in the non-treated",
y = "",
fill = "Severity (%)"
) +
geom_text(size = 4)+
scale_fill_viridis_c(option = "D",begin = 0.3, end = 1, na.value = "grey80") +
ggthemes::theme_few()+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 16, face = "bold"),
strip.text = element_text(size = 16, face = "bold"),
title = element_text(face = "bold"),
legend.position = "right")
p_heat
ggsave("fig/heat_disease.png", bg = "white", dpi = 600, height = 8, width = 12)
p_heat <- ggplot(heat_dat2, aes(x = disease, y = trial_ord, fill = severity,
label = round(severity,2)), fill = "white") +
geom_tile(color = "white", linewidth = 0.2) +
labs(
x = "Disease in the non-treated",
y = "",
fill = "Severity (%)"
) +
geom_text(size = 4)+
scale_fill_viridis_c(option = "D",begin = 0.3, end = 1, na.value = "grey80") +
ggthemes::theme_few()+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 16, face = "bold"),
strip.text = element_text(size = 16, face = "bold"),
title = element_text(face = "bold"),
legend.position = "right")
p_heat
p_heat <- ggplot(heat_dat2, aes(x = disease, y = trial_ord, fill = severity,
label = round(severity, 2))) +
geom_tile(color = "white", linewidth = 0.2) +
geom_text(size = 4, color = "white") +              # <- set text color here
labs(
x = "Disease in the non-treated",
y = "",
fill = "Severity (%)"
) +
scale_fill_viridis_c(option = "D", begin = 0.3, end = 1, na.value = "grey80") +
ggthemes::theme_few() +
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 16, face = "bold"),
strip.text = element_text(size = 16, face = "bold"),
title = element_text(face = "bold"),
legend.position = "right")
p_heat
p_heat <- ggplot(heat_dat2, aes(x = disease, y = trial_ord, fill = severity,
label = round(severity, 2))) +
geom_tile(color = "white", linewidth = 0.2) +
geom_text(size = 5, color = "white") +              # <- set text color here
labs(
x = "Disease in the non-treated",
y = "",
fill = "Severity (%)"
) +
scale_fill_viridis_c(option = "D", begin = 0.3, end = 1, na.value = "grey80") +
ggthemes::theme_few() +
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 16, face = "bold"),
strip.text = element_text(size = 16, face = "bold"),
title = element_text(face = "bold"),
legend.position = "right")
p_heat
ggsave("fig/heat_disease.png", bg = "white", dpi = 600, height = 8, width = 12)
p_heat <- ggplot(heat_dat2, aes(x = disease, y = trial_ord, fill = severity,
label = round(severity, 2))) +
geom_tile(color = "white", linewidth = 0.2) +
geom_text(size = 5, color = "white") +              # <- set text color here
labs(
x = "Disease in the non-treated",
y = "",
fill = "Severity (%)"
) +
scale_fill_viridis_c(option = "D", begin = 0.3, end = 1, na.value = "grey80") +
ggthemes::theme_few() +
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 16, face = "bold"),
strip.text = element_text(size = 16, face = "bold"),
title = element_text(face = "bold"),
legend.position = "right")
p_heat
citation("cowplot")
citation("dplyr")
citation("ggplot2")
citation("dplyr")
citation("ggplot2")
citation("tidytext")
