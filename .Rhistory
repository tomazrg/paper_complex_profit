# pegar também o BLUP de trial e juntar
blup_trial_hybrid_full <- blup_trial_hybrid %>%
left_join(blup_trial, by = "trial") %>%
mutate(
yld_adjusted = mu + blup_trial + blup_trial_hybrid
)
blup_trial_hybrid_full
blup_trial_hybridd = blup_trial_hybrid_full %>%
ggplot(aes(blup_trial_hybrid))+
geom_histogram(color = "white", bins = 15, fill = "tan2")+
ggthemes::theme_few()+
labs(x = "BLUP trial/hybrid (kg/ha)",
y = "Frequency")+
#scale_x_continuous(breaks = seq(0, 3, by = 0.5))+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 16, face = "bold"),
strip.text = element_text(size = 16, face = "bold"),
title = element_text(face = "bold"),
legend.position = "none")
blup_trial = blup_trial_hybrid_full %>%
ggplot(aes(blup_trial))+
geom_histogram(color = "white", bins = 15, fill = "steelblue")+
ggthemes::theme_few()+
labs(x = "BLUP trial (kg/ha)",
y = "")+
#scale_x_continuous(breaks = seq(0, 3, by = 0.5))+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 16, face = "bold"),
strip.text = element_text(size = 16, face = "bold"),
title = element_text(face = "bold"),
legend.position = "none")
yld_adjusted_trial = blup_trial_hybrid_full %>%
ggplot(aes(yld_adjusted_trial))+
geom_histogram(color = "white", bins = 15, fill = "tomato3")+
ggthemes::theme_few()+
labs(x = "Trial Yield (kg/ha)",
y = "Frequency")+
#scale_x_continuous(breaks = seq(0, 3, by = 0.5))+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 16, face = "bold"),
strip.text = element_text(size = 16, face = "bold"),
title = element_text(face = "bold"),
legend.position = "none")
yld_adjusted = blup_trial_hybrid_full %>%
ggplot(aes(yld_adjusted))+
geom_histogram(color = "white", bins = 15, fill = "darkolivegreen4")+
ggthemes::theme_few()+
labs(x = "Overall yield  (kg/ha)",
y = "")+
#scale_x_continuous(breaks = seq(0, 3, by = 0.5))+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 16, face = "bold"),
strip.text = element_text(size = 16, face = "bold"),
title = element_text(face = "bold"),
legend.position = "none")
plot_grid(blup_trial_hybridd,blup_trial,yld_adjusted_trial,yld_adjusted,
labels = c("(a)", "(b)", "(c)", "(d)"),
label_size = 16,
label_fontface = "bold",
ncol = 2,
align = "hv",
label_x = -0.01,
label_y = 1)
ggsave("fig/blup.png", bg = "white", dpi = 600, height = 6, width = 12)
dados3$yld_pred <- predict(test_l, re.form = NULL)  # com efeitos aleatórios
# média predita por cenário
pred_scenario <- dados3 %>%
group_by(application, season, pressao) %>%
summarise(
yld_pred_mean = mean(yld_pred),
.groups = "drop"
)
pred_scenario
dados3$yld_pred_fixed <- predict(test_l, re.form = NA)
pred_scenario_fixed <- dados3 %>%
group_by(application, season, pressao) %>%
summarise(
yld_pred_mean = mean(yld_pred_fixed),
.groups = "drop"
)
pred_scenario_fixed
mod_blup_hybrid <- lmer(
yld ~ application * season * pressao +
(1 | trial) + (1 | hybrid),
data = dados3
)
blup_hybrid <- ranef(mod_blup_hybrid)$hybrid %>%
as.data.frame() %>%
rownames_to_column("hybrid") %>%
rename(blup_hybrid = `(Intercept)`)
mu2 <- fixef(mod_blup_hybrid)[["(Intercept)"]]
blup_hybrid <- blup_hybrid %>%
mutate(yld_adjusted_hybrid = mu2 + blup_hybrid)
blup_hybrid
library(dplyr)
library(tidyr)
# 1) média de rendimento por trial × season × pressao × application
yld_ensaio <- dados2 %>%
group_by(trial, season, application) %>%
summarise(
yld_mean = mean(yield2, na.rm = TRUE),
.groups = "drop"
)
# 2) deixar largo para ter colunas "check" e "treated"
yld_wide <- yld_ensaio %>%
pivot_wider(
names_from  = application,
values_from = yld_mean
)
# 3) ganho de rendimento do fungicida
yld_gain <- yld_wide %>%
mutate(
gain_yld = treated - check   # ajuste o nome dos níveis se forem outros
) %>%
full_join(dados2)
yld_gain
yld_gain2 = yld_gain[,16:26]
yld_gain2$yield = NULL
yld_gain2$yield2 = NULL
yld_gain2$severity = NULL
#yld_gain2$gain_yld = yld_gain$gain_yld
yld_gain2[is.na(yld_gain2)] <- 0
pc <- prcomp(yld_gain2, scale. = TRUE)
pc
yld_gain2$PC1 <- pc$x[, 1]
yld_gain2$trat = yld_gain$trat
yld_gain2$check = yld_gain$check
yld_gain2$gain_yld = yld_gain$gain_yld
yld_gain2$hybrid = yld_gain$hybrid
#yld_gain2$trial = yld_gain$trial
pc$rotation
yld_gain2 = yld_gain2 %>%
filter(!PC1 < -5) %>%
filter(!is.na(check))
pc_test = lm(gain_yld ~ PC1, data = yld_gain2)
summary(pc_test)
confint(pc_test)
cort = cor.test(yld_gain2$branca, yld_gain2$PC1)
cort
model_yld = yld_gain2 %>%
#  filter(!PC1 < -5) %>%
ggplot(aes(x = -PC1, y = gain_yld)) +
geom_point(color = NA)+
geom_abline(aes(intercept = 456.70,slope = -323.02),
size = 2, fill = "black", color = "black")+
geom_abline(aes(intercept = 422.5008,slope = -362.9303) ,
size = 1, linetype = 2)+
geom_abline(aes(intercept = 490.9017,slope = -283.1105), size = 1, linetype = 2)+
xlim(0,5)+
ylim(-2000,2000)+
scale_x_continuous(expand = c(0, 0),
limits = c(0,5)) +
scale_y_continuous(expand = c(0, 0),
limits = c(-2000,2000),
breaks = seq(-2000,2000, by = 500))+
labs(y = "Yield gain (kg/ha)",
x = "PC1")+
ggthemes::theme_few()+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 20, face = "bold"),
strip.text = element_text(size = 20, face = "bold"),
title = element_text(face = "bold"),
legend.position = "none")
check_hist = yld_gain2 %>%
ggplot(aes(gain_yld))+
geom_histogram(color = "white", fill = "darkgreen", bins = 15)+
labs(x = "Yield gain (kg/ha)",
y = "Frequency")+
ggthemes::theme_few()+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 20, face = "bold"),
strip.text = element_text(size = 20, face = "bold"),
title = element_text(face = "bold"),
legend.position = "none")
pc1_plot = yld_gain2 %>%
ggplot(aes(-PC1))+
geom_histogram(color = "white", fill = "darkred", bins = 15)+
labs(x = "PC1",
y = "Frequency")+
ggthemes::theme_few()+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 20, face = "bold"),
strip.text = element_text(size = 20, face = "bold"),
title = element_text(face = "bold"),
legend.position = "none")
(model_yld)+check_hist/pc1_plot+
plot_annotation(tag_levels = "a", tag_prefix = "(", tag_suffix = ")") +
theme(plot.tag = element_text(face = "bold", size = 12), label_x = -0.03, label_y = 1)
ggsave("fig/PC1_yield.png", bg = "white", dpi = 600, height = 8, width = 12)
autoplot(pc)
autoplot(pc)
biplot(pc)
# Vetor com os nomes das colunas de doenças
doencas <- c("cercos", "turc", "comum", "branca",
"poli", "diplo", "antrac", "bipol")
# Converte todas as colunas de doenças para numéricas de uma vez
yld_gain2[doencas] <- lapply(yld_gain2[doencas], function(x) as.numeric(as.character(x)))
# Também garante que PC1 seja numérico
yld_gain2$PC1 <- as.numeric(as.character(yld_gain2$PC1))
# Calcula correlação para cada doença
resultados <- lapply(doencas, function(d) {
# Remove linhas com NA em qualquer das duas variáveis
dados <- yld_gain2[complete.cases(yld_gain2[[d]], yld_gain2$PC1), ]
teste <- cor.test(dados[[d]], dados$PC1)
data.frame(
mean  = teste$estimate,
upper = teste$conf.int[1],
lower = teste$conf.int[2],
row.names = d
)
})
# Junta tudo em um único dataframe
df_cor <- do.call(rbind, resultados)
print(df_cor)
library(ggplot2)
# Transformar rownames em coluna para usar no ggplot
df_cor$doenca <- rownames(df_cor)
# Ordenar os níveis do fator pela média
df_cor$doenca <- factor(df_cor$doenca, levels = df_cor$doenca[order(df_cor$mean)])
# Criar gráfico ordenado
ggplot(df_cor, aes(x = doenca, y = mean, ymin = lower, ymax = upper)) +
geom_pointrange(color = "steelblue", size = 0.8) +
geom_hline(yintercept = 0, linetype = "dashed", color = "red") + # linha de referência
labs(
x = "Disease",
y = "Pearson's correlation") +
coord_flip()+
ggthemes::theme_few()
mean
library(dplyr)
library(tibble)
library(factoextra)
library(cluster)
library(pheatmap)
yield_gain_unique <- yld_gain2 %>%
distinct(hybrid, .keep_all = TRUE)
pc1_df <- yield_gain_unique %>%
dplyr::select(hybrid, PC1) %>%
distinct()
pc1_matrix <- pc1_df %>%
column_to_rownames("hybrid")
pc1_scaled <- scale(pc1_matrix)
dist_pc1 <- dist(pc1_scaled, method = "euclidean")
clust <- hclust(dist_pc1, method = "ward.D2")
ks <- 2:10
sil_means <- sapply(ks, function(k){
grupos_k <- cutree(clust, k = k)
sil      <- cluster::silhouette(grupos_k, dist_pc1)
mean(sil[, "sil_width"])
})
k_opt <- ks[which.max(sil_means)]
k_opt
pc1_df$GROUP <- cutree(clust, k = k_opt)
pc1_groups <- pc1_df %>%
arrange(PC1) %>%
rename(cultivar = hybrid,
grupo = GROUP)
print(pc1_groups)
fig_pc1 <- factoextra::fviz_dend(
clust,
k = k_opt,
rect = FALSE,
rect_fill = TRUE,
rect_border = "gray30",
cex = 0.8,
color_labels_by_k = TRUE,
labels_track_height = 0.8,
k_colors = c("tan2","darkolivegreen4")[1:k_opt],
guides = "none",
horiz = TRUE,
main = paste("")
) +
labs(y = "Euclidean distance") +
ggthemes::theme_few()+
theme(
axis.text.x = element_text(size = 18, face = "bold"),
axis.title.x = element_text(size = 20, face = "bold"),
axis.text.y = element_text(size = 18, face = "bold")
)
print(fig_pc1)
ggsave("fig/dendogram.png", bg = "white", dpi = 600, height = 18, width = 20)
plot_poli = dados2 %>%
filter(poli > 0) %>%
ggplot(aes(poli))+
geom_histogram(color = "white", bins = 10, fill = "tan3")+
ggthemes::theme_few()+
labs(x = "",
y = "Frequency")+
ggthemes::theme_few()+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 20, face = "bold"),
strip.text = element_text(size = 20, face = "bold"),
title = element_text(face = "bold"),
legend.position = "none")
plot_comum =dados2 %>%
filter(comum > 0) %>%
ggplot(aes(comum))+
geom_histogram(color = "white", bins = 10, fill = "tomato3")+
ggthemes::theme_few()+
labs(x = "",
y = "")+
ggthemes::theme_few()+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 20, face = "bold"),
strip.text = element_text(size = 20, face = "bold"),
title = element_text(face = "bold"),
legend.position = "none")
plot_branca = dados2 %>%
filter(branca > 0) %>%
ggplot(aes(branca))+
geom_histogram(color = "white", bins = 10, fill = "steelblue")+
ggthemes::theme_few()+
labs(x = "",
y = "")+
ggthemes::theme_few()+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 20, face = "bold"),
strip.text = element_text(size = 20, face = "bold"),
title = element_text(face = "bold"),
legend.position = "none")
plot_cercos = dados2 %>%
filter(cercos > 0) %>%
ggplot(aes(cercos))+
geom_histogram(color = "white", bins = 10, fill = "darkgreen")+
ggthemes::theme_few()+
labs(x = "",
y = "")+
ggthemes::theme_few()+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 20, face = "bold"),
strip.text = element_text(size = 20, face = "bold"),
title = element_text(face = "bold"),
legend.position = "none")
plot_turc = dados2 %>%
filter(turc > 0) %>%
ggplot(aes(turc))+
geom_histogram(color = "white", bins = 10, fill = "darkorange")+
ggthemes::theme_few()+
labs(x = "Severity (%)",
y = "Frequency")+
ggthemes::theme_few()+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 20, face = "bold"),
strip.text = element_text(size = 20, face = "bold"),
title = element_text(face = "bold"),
legend.position = "none")
plot_diplo = dados2 %>%
filter(diplo > 0) %>%
ggplot(aes(diplo))+
geom_histogram(color = "white", bins = 10, fill = "black")+
ggthemes::theme_few()+
labs(x = "Severity (%)",
y = "")+
ggthemes::theme_few()+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 20, face = "bold"),
strip.text = element_text(size = 20, face = "bold"),
title = element_text(face = "bold"),
legend.position = "none")
plot_antrac = dados2 %>%
#filter(antrac > 0) %>%
ggplot(aes(antrac))+
geom_histogram(color = "white", bins = 10, fill = "darkred")+
ggthemes::theme_few()+
labs(x = "Severity (%)",
y = "")+
ggthemes::theme_few()+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 20, face = "bold"),
strip.text = element_text(size = 20, face = "bold"),
title = element_text(face = "bold"),
legend.position = "none")
plot_bipol = dados2 %>%
#filter(antrac > 0) %>%
ggplot(aes(bipol))+
geom_histogram(color = "white", bins = 10, fill = "grey")+
ggthemes::theme_few()+
labs(x = "Severity (%)",
y = "")+
ggthemes::theme_few()+
theme(text = element_text(size = 14, face = "bold"),
axis.title = element_text(size = 20, face = "bold"),
strip.text = element_text(size = 20, face = "bold"),
title = element_text(face = "bold"),
legend.position = "none")
plot_grid(plot_poli,plot_comum,plot_branca,plot_cercos,plot_turc,plot_diplo,plot_antrac,plot_bipol, ncol = 4,
labels = c("(a)", "(b)", "(c)", "(d)", "(e)", "(f)", "(g)","(h)",
label_size = 16,          # tamanho da fonte das labels
label_fontface = "bold",  # coloca as labels em negrito
ncol = 2,                 # duas colunas
align = "hv",
label_x = -0.01,
label_y = 1))
ggsave("fig/disease_severity.png", bg = "white", dpi = 600, height = 6, width = 12)
mean
# Criar gráfico ordenado
ggplot(df_cor, aes(x = doenca, y = mean, ymin = lower, ymax = upper)) +
geom_pointrange(color = "steelblue", size = 0.8) +
geom_hline(yintercept = 0, linetype = "dashed", color = "red") + # linha de referência
labs(
x = "Disease",
y = "Pearson's correlation") +
coord_flip()+
ggthemes::theme_few()
summary(mm2)
dados3 =dados3 %>%
mutate(
pressao = ifelse(sev > 10, "high", "low"))
test_l = lmer(yld ~ application * season *  pressao + (1 | trial) + (1 | trial:hybrid), data = dados3)
summary(test_l)
saveRDS(test_l, file = "data/modelo_lmer.rds")
test_l
emm2 = emmeans(test_l, ~ application * pressao)
mm2 = contrast(emm2, method = "revpairwise", by = "pressao")
summary(mm2)
saveRDS(test_l, file = "data/lmer.rds")
saveRDS(test_l, file = "data/lmer.rds")
test_l <- readRDS("data/lmer.rds")
summary(test_l)
anova(test_l)
summary(test_l)
confint()
confint(test_l)
dados3
## Packages
```{r}
library(gsheet)
library(tidyverse)
library(lme4)
library(metan)
library(DHARMa)
library(metafor)
library(cowplot)
dados <- gsheet2tbl("https://docs.google.com/spreadsheets/d/1pUGN7bPHtENsO8eb-f8J1q6_pbMqm86bVnaNlgClleo/edit?usp=sharing")
library(tidyr)
library(dplyr)
dados_long <- dados %>%
pivot_longer(
cols = c(poli, comum, branca, cercos, turc, diplo,antrac,bipol),
names_to = "disease",
values_to = "value"
)
library(dplyr)
freq_disease_season <- dados_long %>%
mutate(
value = as.numeric(value),
presente = ifelse(value > 0.00, 1, 0)
) %>%
group_by(season, disease) %>%
summarise(
n_presentes = sum(presente, na.rm = TRUE),
total = n(),
freq = round(n_presentes / total * 100, 1),
.groups = "drop"
)
dados_long = dados_long %>%
mutate(
type = case_when(disease == "cercos" ~ "spot",
disease == "turc" ~ "spot",
disease == "diplo" ~ "spot",
disease == "antrac" ~ "spot",
disease == "bipol" ~ "spot",
disease == "poli" ~ "rust",
disease == "comum" ~ "rust",
disease == "branca" ~ "rust")
)
frequency = dados_long %>%
filter(application == "check") %>%
group_by(season,hybrid,disease,location) %>%
dplyr::summarise(
value = mean(value, na.rm = TRUE)
) %>%
mutate(
value = as.numeric(value),
presente = ifelse(value > 0.0, 1, 0)
) %>%
group_by(season, disease) %>%
summarise(
n_presentes = sum(presente, na.rm = TRUE),
total = n(),
freq = round(n_presentes / total * 100, 1),
.groups = "drop"
)
frequency
dados2 <- dados |>
mutate(trial = interaction(year, location, season, hybrid))
dados3 <- dados2 |>
dplyr::group_by(trial, year, location, season, hybrid, technology, application) |>
dplyr::summarize(sev = mean(severity),
yld = mean(yield2),
sd_sev = sd(severity),
sd_yld = sd(yield2),
n = n()
)
dados_meta <- dados3 %>%
dplyr::select(trial, year, location, season, hybrid, technology, application, yld, sd_yld, n, sev) %>%
pivot_wider(
names_from = application,
values_from = c(yld, sd_yld,n, sev),
names_sep = "_"
) %>%
dplyr::mutate(
study_id = paste(trial, year, location, season, hybrid, sep = "_"),
pressao = ifelse(sev_check > 10, "high", "low"),
yi = yld_treated - yld_check,
sei = sqrt((sd_yld_treated^2 / n_treated) + (sd_yld_check^2 / n_check))
) %>%
drop_na(yi, sei)
dados_meta
writexl::write_xlsx(dados3,"data/data3.xlsx")
dados3 = readxl::read_xlsx("data/dados3.xlsx")
dados3 = readxl::read_xlsx("data/data3.xlsx")
